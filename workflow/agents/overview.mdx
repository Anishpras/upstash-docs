---
title: "Overview"
---

One of the biggest trends as 2025 starts is the concept of agents. Agents are LLMs which can use tools available to them and collaborate to achieve a task given by the user.

One problem with agents is that they can take some time to accomplish their task and this can lead to timeouts and errors during execution. How about utilizing Upstash Workflow to address these issues? Upstash Workflow has a [set of features](/workflow/getstarted) which can help us in this case.

With Agents API of Upstash Workflow, you can:
- Pass any tool compatible with AI SDK or LangChain.
- Run an agent by itself or make a number of agents collaborate.
- Reliably invoke agents without having to worry about timeouts or transient errors.

# Getting Started

If you are starting with Upstash Workflow for the first time, you may want to check out [Local Development documentation](/workflow/howto/local-development) to use Upstash Workflow locally.

<Tip>
In this guide we will use Next.js. If you are using a different framework we support, you can find how you can define a workflow endpoint by checking [the quickstarts](/workflow/quickstarts/platforms).
</Tip>

##  Installation

First step is to install packages Upstash Workflow, AI SDK (for defining custom tools) and LangChain (for tools):

```
npm i @upstash/workflow@0.2.5-agents ai @langchain/community mathjs
```

## Defining the Model

We currently only support OpenAI in Agents. More providers will be provided over time. Feel free to reach out if you have a specific provider request.

First, update your environment with `OPENAI_API_KEY`:

```
OPENAI_API_KEY="<OPENAI_API_KEY>"
```

Next, go to your route and define the model:

```ts route.ts {4}
import { serve } from "@upstash/workflow/nextjs";

export const { POST } = serve(async (context) => {
  const model = context.agents.openai('gpt-3.5-turbo')

  // ...
})
```

`model` will be what decides which tools to call and generates the final response as you will see in the following sections.

## Defining Tools

Next, we will define the tools our agents will use. Agents API is compatible with both AI SDK and LangChain tools. This means, you can either use existing tools compatible with these SDKs or define your own tools compatible with these SDKs.

<CodeGroup>

```ts AI SDK
import { z } from 'zod'
import { tool } from 'ai'
import * as mathjs from 'mathjs'

const mathTool = tool({
  description:
    'A tool for evaluating mathematical expressions. ' +
    'Example expressions: ' +
    "'1.2 * (2 + 4.5)', '12.7 cm to inch', 'sin(45 deg) ^ 2'.",
  parameters: z.object({ expression: z.string() }),
  execute: async ({ expression }) => mathjs.evaluate(expression),
})
```

```ts LangChain
import { WikipediaQueryRun } from '@langchain/community/tools/wikipedia_query_run'

const wikiTool = new WikipediaQueryRun({
  topKResults: 1,
  maxDocContentLength: 500,
})
```

</CodeGroup>

## Defining Agents

After defining a model and tools, we can define agents. Agents are basically LLM models with access to a set of tools and a background.

In Upstash Workflow, they are defined like this:

```ts route.ts
import { serve } from "@upstash/workflow/nextjs";
import { WikipediaQueryRun } from '@langchain/community/tools/

export const { POST } = serve(async (context) => {
  const model = context.agents.openai('gpt-3.5-turbo')

  const researcherAgent = context.agents.agent({
    model,
    name: 'academic',
    maxSteps: 2,
    tools: {
      wikiTool: new WikipediaQueryRun({
        topKResults: 1,
        maxDocContentLength: 500,
      })
    },
    background:
      'You are researcher agent with access to Wikipedia. ' +
      'Utilize Wikipedia as much as possible for correct information',
  })
})
```

The parameters of the agent are:
- `model`: LLM model our agent will use
- `name`: Name of the agent. This name will be used when naming the [context.call steps](/workflow/basics/context#context-call) of this agent. context.call is used when calling the LLM provider (in this example, OpenAI).
- `maxSteps`: Number of times this agent can call the LLM provider (in this example, OpenAI).
- `tools`: Tools available to this agent.
- `background`: Description of this agent. Used as system prompt.

## Running Tasks

Now that we have agents, only thing that remains is to assign tasks to them. A task is simply a prompt passed to the agent.

There are two alternatives when creating a task:
- Create a task with a single agent. The agent will complete the task using the tools available to it.
- Create a task with multiple agents. A manager agent will decide which agents will be used and in what order; based on the prompt, agent backgrounds and tools available to them.

### Single Agent

```ts Single Agent {22-27}
import { serve } from "@upstash/workflow/nextjs";
import { WikipediaQueryRun } from "@langchain/community/tools/wikipedia_query_run";

export const { POST } = serve(async (context) => {
  const model = context.agents.openai('gpt-3.5-turbo');

  const researcherAgent = context.agents.agent({
    model,
    name: 'academic',
    maxSteps: 2,
    tools: {
      wikiTool: new WikipediaQueryRun({
        topKResults: 1,
        maxDocContentLength: 500,
      })
    },
    background:
      'You are researcher agent with access to Wikipedia. ' +
      'Utilize Wikipedia as much as possible for correct information',
  });

  const task = context.agents.task({
    agent: researcherAgent,
    prompt: "Tell me about 5 topics in advanced physics.",
  });
  const { text } = await task.run();
  console.log("result:", text)
})
```

As response to the task, the agents generate the following response:

```
Here are summaries of 5 topics in advanced physics:

1. **Quantum Mechanics**: Quantum mechanics is a fundamental theory that describes the behavior of nature at and below the scale of atoms. It is the foundation of all quantum physics, including quantum chemistry, quantum field theory, quantum technology, and quantum information science. Quantum mechanics can describe many systems that classical physics cannot.

2. **General Relativity**: General relativity, also known as Einstein's theory of gravity, is the geometric theory of gravitation published by Albert Einstein in 1915. It is the current description of gravitation in modern physics, generalizing special relativity and refining Newton's law of universal gravitation. General relativity provides a unified description of gravity as a geometric property of space and time.

3. **Particle Physics**: Particle physics, also known as high-energy physics, is the study of fundamental particles and forces that constitute matter and radiation. The field also studies combinations of elementary particles up to the scale of protons and neutrons. Fundamental particles in the universe are classified in the Standard Model as fermions (matter particles) and bosons (force-carrying particles).

4. **Astrophysics**: Astrophysics is a science that applies the methods and principles of physics and chemistry to the study of astronomical objects and phenomena. It seeks to ascertain the nature of heavenly bodies and is distinct from celestial mechanics, which focuses on the positions and motions of objects in space. Subjects studied in astrophysics include the Sun, stars, galaxies, and the universe.

5. **String Theory**: String theory is a theoretical framework in physics where point-like particles are replaced by one-dimensional objects called strings. These strings describe how they propagate through space and interact with each other. On distance scales larger than the string scale, a string behaves like a particle, with its properties determined by the vibrational state of the string
```

Here are the logs on Upstash Console:

<img src="/img/workflow/agents/single-agent.png" />

In the logs, you can see that the acamdemic agent was called and it decided to call wikiTool five times in parallel. After the tool requests were completed, the agent summarised their result in one final call and returned.

### Multi Agents

```ts Multi Agents {45-52}
import { serve } from "@upstash/workflow/nextjs";
import { WikipediaQueryRun } from "@langchain/community/tools/wikipedia_query_run";
import * as mathjs from 'mathjs'
import { tool } from "ai";
import { z } from "zod";

export const { POST } = serve(async (context) => {
  const model = context.agents.openai('gpt-3.5-turbo');

  const researcherAgent = context.agents.agent({
    model,
    name: 'academic',
    maxSteps: 2,
    tools: {
      wikiTool: new WikipediaQueryRun({
        topKResults: 1,
        maxDocContentLength: 500,
      })
    },
    background:
      'You are researcher agent with access to Wikipedia. ' +
      'Utilize Wikipedia as much as possible for correct information',
  });

  const mathAgent = context.agents.agent({
    model,
    name: "mathematician",
    maxSteps: 2,
    tools: {
      calculate: tool({
        description:
          'A tool for evaluating mathematical expressions. ' +
          'Example expressions: ' +
          "'1.2 * (2 + 4.5)', '12.7 cm to inch', 'sin(45 deg) ^ 2'." +
          "only call this tool if you need to calculate a mathematical expression",
        parameters: z.object({ expression: z.string() }),
        execute: async ({ expression }) => mathjs.evaluate(expression),
      }),
    },
    background:
      "You are a mathematician agent which can utilize" +
      "a calculator to compute expressions"
  })

  const task = context.agents.task({
    model,
    maxSteps: 3,
    agents: [researcherAgent, mathAgent],
    prompt: "Tell me about 3 cities in Japan by name and calculate 100*10-10",
  });
  const { text } = await task.run();
  console.log("result:", text)
})
```

As response to the task, the agents generate the following response:

```
Here is some information about Tokyo, Kyoto, and Osaka:

### Tokyo
- Tokyo, officially the Tokyo Metropolis, is the capital of Japan.
- It has a population of over 14 million in the city proper as of 2023.
- The Greater Tokyo Area, which includes Tokyo and parts of six neighboring prefectures, is the most populous metropolitan area in the world, with 41 million residents as of 2024.

### Kyoto
- Kyoto is the capital city of Kyoto Prefecture in the Kansai region of Japan's largest island, Honshu.
- As of 2020, the city had a population of 1.46 million, making it the ninth-most populous city in Japan.
- More than half of Kyoto Prefecture's population resides in the city.

### Osaka
- Osaka is a designated city in the Kansai region of Honshu in Japan.
- It is the capital of and most populous city in Osaka Prefecture, and the third-most populous city in Japan.
- With a population of 2.7 million in the 2020 census, it is also the largest component of the Keihanshin Metropolitan Area.

The result of the expression (100 times 10 - 10) is 990.
```

Here are the logs on Upstash Console:

<img src="/img/workflow/agents/multi-agent.png" />

In the logs, you can see that `Manager LLM` decided to call both agents (`academic` and `mathematician`). Then, these agents called their own tools. `academic` called `wikiTool` three times and `mathematician` requested `calculate`. After the tool results were delivered, the agents summarised their results. Finally, `Manager LLM` summarised the response from the two agents.
